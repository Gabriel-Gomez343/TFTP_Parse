

#include "tftp.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

int main(int argc, char *argv[])
{
	char *packets[] = {
		"\x00\x01\x64\x6f\x70\x65\x5f\x66\x69\x6c\x65\x2e\x64\x61\x74\x00\x6e\x65\x74\x61\x73\x63\x69\x69\x00",
		"\x00\x02\x62\x6f\x6f\x74\x2e\x69\x6e\x69\x00\x6e\x65\x74\x61\x73\x63\x69\x69\x00",
		"\x00\x03\x00\x37\x4c\x6f\x72\x65\x6d\x20\x69\x70\x73\x75\x6d\x20\x64\x6f\x6c\x6f\x72\x20\x73\x69\x74\x20\x61\x6d\x65\x74\x2c\x20\x63\x6f\x6e\x73\x65\x63\x74\x65\x74\x75\x72\x20\x61\x64\x69\x70\x69\x73\x63\x69\x6e\x67\x20\x65\x6c\x69\x74\x2e\x20\x55\x74\x20\x73\x65\x64\x20\x69\x70\x73\x75\x6d\x20\x6e\x69\x73\x69\x2e\x20\x45\x74\x69\x61\x6d\x20\x75\x6c\x74\x72\x69\x63\x65\x73\x20\x76\x65\x6c\x20\x75\x72\x6e\x61\x20\x76\x65\x6c\x20\x73\x75\x73\x63\x69\x70\x69\x74\x2e\x20\x50\x72\x61\x65\x73\x65\x6e\x74\x20\x76\x69\x76\x65\x72\x72\x61\x20\x75\x6c\x74\x72\x69\x63\x65\x73\x20\x6f\x64\x69\x6f\x2c\x20\x76\x65\x6c\x20\x75\x6c\x6c\x61\x6d\x63\x6f\x72\x70\x65\x72\x20\x6c\x69\x62\x65\x72\x6f\x20\x66\x69\x6e\x69\x62\x75\x73\x20\x76\x65\x6c\x2e\x20\x50\x65\x6c\x6c\x65\x6e\x74\x65\x73\x71\x75\x65\x20\x74\x69\x6e\x63\x69\x64\x75\x6e\x74\x2c\x20\x61\x75\x67\x75\x65\x20\x61\x20\x69\x6d\x70\x65\x72\x64\x69\x65\x74\x20\x70\x6c\x61\x63\x65\x72\x61\x74\x2c\x20\x6c\x69\x67\x75\x6c\x61\x20\x74\x6f\x72\x74\x6f\x72\x20\x73\x75\x73\x63\x69\x70\x69\x74\x20\x73\x65\x6d\x2c\x20\x69\x6e\x20\x70\x6f\x73\x75\x65\x72\x65\x20\x61\x6e\x74\x65\x20\x6f\x64\x69\x6f\x20\x61\x74\x20\x6d\x61\x75\x72\x69\x73\x2e\x20\x50\x65\x6c\x6c\x65\x6e\x74\x65\x73\x71\x75\x65\x20\x68\x61\x62\x69\x74\x61\x6e\x74\x20\x6d\x6f\x72\x62\x69\x20\x74\x72\x69\x73\x74\x69\x71\x75\x65\x20\x73\x65\x6e\x65\x63\x74\x75\x73\x20\x65\x74\x20\x6e\x65\x74\x75\x73\x20\x65\x74\x20\x6d\x61\x6c\x65\x73\x75\x61\x64\x61\x20\x66\x61\x6d\x65\x73\x20\x61\x63\x20\x74\x75\x72\x70\x69\x73\x20\x65\x67\x65\x73\x74\x61\x73\x2e\x20\x4e\x75\x6e\x63\x20\x72\x69\x73\x75\x73\x20\x65\x78\x2c\x20\x65\x6c\x65\x6d\x65\x6e\x74\x75\x6d\x20\x69\x64\x20\x66\x65\x75\x67\x69\x61\x74\x20\x71\x75\x69\x73\x2c\x20\x65\x66\x66\x69\x63\x69\x74\x75\x72\x20\x75\x74\x20\x6d\x61\x73\x73\x61\x2e\x20\x4d\x61\x75\x72\x69\x73\x20\x61\x63\x20\x61\x75\x63\x74\x6f\x72\x20\x64\x75\x69\x2e\x20\x50\x65\x6c\x6c\x65\x6e\x74\x65\x73\x71\x75\x65\x20\x65\x67\x65\x73\x74\x61\x73\x20\x6c\x65\x63\x74\x75\x73\x20\x76\x69\x74\x61\x65\x20\x61\x75\x67\x75\x65\x2e",
		"\x00\x03\x00\x38\x4c\x6f\x72\x65\x6d\x20\x69\x70\x73\x75\x6d\x20\x64\x6f\x6c\x6f\x72\x20\x73\x69\x74\x20\x61\x6d\x65\x74\x2c\x20\x63\x6f\x6e\x73\x65\x63\x74\x65\x74\x75\x72\x20\x61\x64\x69\x70\x69\x73\x63\x69\x6e\x67\x20\x65\x6c\x69\x74\x2e\x20\x55\x74\x20\x73\x65\x64\x20\x69\x70\x73\x75\x6d\x20\x6e\x69\x73\x69\x2e\x20\x45\x74\x69\x61\x6d\x20\x75\x6c\x74\x72\x69\x63\x65\x73\x20\x76\x65\x6c\x20\x75\x72\x6e\x61\x20\x76\x65\x6c\x20\x73\x75\x73\x63\x69\x70\x69\x74\x2e\x20\x50\x72\x61\x65\x73\x65\x6e\x74\x20\x76\x69\x76\x65\x72\x72\x61\x20\x75\x6c\x74\x72\x69\x63\x65\x73\x20\x6f\x64\x69\x6f\x2c\x20\x76\x65\x6c\x20\x75\x6c\x6c\x61\x6d\x63\x6f\x72\x70\x65\x72\x20\x6c\x69\x62\x65\x72\x6f\x20\x66\x69\x6e\x69\x62\x75\x73\x20\x76\x65\x6c\x2e\x20\x50\x65\x6c\x6c\x65\x6e\x74\x65\x73\x71\x75\x65\x20\x74\x69\x6e\x63\x69\x64\x75\x6e\x74\x2c\x20\x61\x75\x67\x75\x65\x20\x61\x20\x69\x6d\x70\x65\x72\x64\x69\x65\x74\x20\x70\x6c\x61\x63\x65\x72\x61\x74\x2c\x20\x6c\x69\x67\x75\x6c\x61\x20\x74\x6f\x72\x74\x6f\x72\x20\x73\x75\x73\x63\x69\x70\x69\x74\x20\x73\x65\x6d\x2c\x20\x69\x6e\x20\x70\x6f\x73\x75\x65\x72\x65\x20\x61\x6e\x74\x65\x20\x6f\x64\x69\x6f\x20\x61\x74\x20\x6d\x61\x75\x72\x69\x73\x2e\x20\x50\x65\x6c\x6c\x65\x6e\x74\x65\x73\x71\x75\x65\x20\x68\x61\x62\x69\x74\x61\x6e\x74\x20\x6d\x6f\x72\x62\x69\x20\x74\x72\x69\x73\x74\x69\x71\x75\x65\x20\x73\x65\x6e\x65\x63\x74\x75\x73\x20\x65\x74\x20\x6e\x65\x74\x75\x73\x20\x65\x74\x20\x6d\x61\x6c\x65\x73\x75\x61\x64\x61\x20\x66\x61\x6d\x65\x73\x20\x61\x63\x20\x74\x75\x72\x70\x69\x73\x20\x65\x67\x65\x73\x74\x61\x73\x2e\x20\x4e\x75\x6e\x63\x20\x72\x69\x73\x75\x73\x20\x65\x78\x2c\x20\x65\x6c\x65\x6d\x65\x6e\x74\x75\x6d\x20\x69\x64\x20\x66\x65\x75\x67\x69\x61\x74\x20\x71\x75\x69\x73\x2c\x20\x65\x66\x66\x69\x63\x69\x74\x75\x72\x20\x75\x74\x20\x6d\x61\x73\x73\x61\x2e\x20\x4d\x61\x75\x72\x69\x73\x20\x61\x63\x20\x61\x75\x63\x74\x6f\x72\x20\x64\x75\x69\x2e\x20\x50\x65\x6c\x6c\x65\x6e\x74\x65\x73\x71\x75\x65\x20\x65\x67\x65\x73\x74\x61\x73\x20\x6c\x65\x63\x74\x75\x73\x20\x76\x69\x74\x61\x65\x20\x61\x75\x67\x75\x65",
		"\x00\x04\x00\x37",
		"\x00\x05\x00\x02\x41\x63\x63\x65\x73\x73\x20\x76\x69\x6f\x6c\x61\x74\x69\x6f\x6e\x2e"};
	int n = 6;

	// probably a switch statement, eh?
	char temp[9];
	int j, current;

	for (int i = 0; i < n; i++)
	{
		j = 2;
		switch (packets[i][1])
		{
		case '\x01':;
			RQ read;
			read.opcode = 1;
			read.filename = &packets[i][j];
			
			while (packets[i][j] != '\x00')
			{
				j++;
			}
			read.mode = &packets[i][j+1];
			
			handle_read_request(&read);

			break;
		case '\x02':;
			RQ write;
			write.opcode = 2;
			write.filename = &packets[i][j];

			while (packets[i][j] != '\x00')
			j++;

			write.mode = &packets[i][j+1];

			handle_write_request(&write);
			break;
		case '\x03':;
			DP data;
			data.opcode = 3;
			data.block = packets[i][3];
			data.data = &packets[i][4];
			data.last = (strlen(data.data) == 512);

			handle_data_packet(&data);
			break;
		case '\x04':;
			ACK ack;
			ack.opcode = 4;
			ack.block = packets[i][3];

			handle_ack_packet(&ack);
			break;
		case '\x05':;
			EP err;
			err.opcode = 5;
			err.error = packets[i][3];

			err.msg = &packets[i][4];
			handle_error_packet(&err);
		break;
		default:
			printf("Invalid opcode");
			break;
		}
		
	}

	return EXIT_SUCCESS;
}

void handle_read_request(RQ *rrq)
{
	printf("READ:\nOpcode: %d\n", rrq->opcode);
	printf("Filename: ");
	puts(rrq->filename);
	printf("Mode: ");
	puts(rrq->mode);

	
}

void handle_write_request(RQ *wrq)
{
	printf("WRITE:\nOpcode: %d\n", wrq->opcode);
	printf("Filename: ");
	puts(wrq->filename);
	printf("Mode: ");
	puts(wrq->mode);

}

void handle_data_packet(DP *dp)
{
	printf("DATA:\nOpcode: %d\n", dp->opcode);
	printf("Block: %d\n", dp->block);
	printf("Last? %s\n", dp->last ? "True" : "False");
	printf("Data: %*.*s...(%ld bytes total)\n", 30, 30, dp->data, strlen(dp->data));
}

void handle_ack_packet(ACK *ack)
{
	printf("ACK:\nOpcode: %d\n", ack->opcode);
	printf("Block: %d\n", ack->block);
}

void handle_error_packet(EP *ep)
{
	printf("ERROR:\nOpcode: %d\n", ep->opcode);
	printf("Code: %d\n", ep->error);
	printf("Message: ");
	puts(ep->msg);

}
